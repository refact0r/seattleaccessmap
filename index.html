<!doctype html>
<html>
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Seattle Sidewalk Accessibility Hotspots</title>
		<link
			rel="stylesheet"
			href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
		/>
		<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
		<script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
		<style>
			body {
				margin: 0;
				padding: 0;
				font-family:
					-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto,
					Oxygen, Ubuntu, Cantarell, sans-serif;
			}
			#map {
				width: 100%;
				height: 100vh;
			}
			.info-panel {
				position: absolute;
				top: 10px;
				left: 10px;
				background: white;
				padding: 15px 20px;
				border-radius: 8px;
				box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
				z-index: 1000;
				max-width: 300px;
			}
			.info-panel h3 {
				margin: 0 0 10px 0;
				font-size: 16px;
			}
			.info-panel p {
				margin: 5px 0;
				font-size: 13px;
				color: #666;
			}
			.loading {
				text-align: center;
				padding: 20px;
			}
			.legend {
				position: absolute;
				bottom: 30px;
				right: 10px;
				background: white;
				padding: 10px 15px;
				border-radius: 8px;
				box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
				z-index: 1000;
			}
			.legend h4 {
				margin: 0 0 8px 0;
				font-size: 13px;
			}
			.legend-item {
				display: flex;
				align-items: center;
				margin: 4px 0;
				font-size: 12px;
			}
			.legend-color {
				width: 20px;
				height: 20px;
				border-radius: 50%;
				margin-right: 8px;
				border: 1px solid #333;
			}
		</style>
	</head>
	<body>
		<div id="map"></div>
		<div class="info-panel">
			<h3>üö∂ Seattle Sidewalk Accessibility</h3>
			<p>Top 30 hotspots identified by cluster analysis</p>
			<p>
				<strong>Toggle layers</strong> using the control in the
				top-right
			</p>
			<p><strong>Click any point</strong> for detailed breakdown</p>
		</div>

		<script>
			// Initialize map with zoom controls in bottom-left
			const map = L.map('map', {
				zoomControl: false,
			})

			// Add zoom control to bottom-left
			L.control
				.zoom({
					position: 'bottomleft',
				})
				.addTo(map)

			// Add base tile layer
			L.tileLayer(
				'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',
				{
					attribution:
						'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
					subdomains: 'abcd',
					maxZoom: 20,
				},
			).addTo(map)

			// Layer groups
			const layers = {}
			let heatmapLayer = null

			// Load data and render
			Promise.all([
				fetch('output/clusters_data.json').then((r) => r.json()),
				fetch('output/heatmap_data.json').then((r) => r.json()),
			])
				.then(([clustersData, heatmapData]) => {
					const { config, clusters } = clustersData

					// Set map view
					map.setView(config.center, config.zoom_start)

					// Add heatmap layer
					heatmapLayer = L.heatLayer(
						heatmapData.map(([lat, lng, severity]) => [
							lat,
							lng,
							severity / 5,
						]),
						{
							radius: 6,
							blur: 10,
							maxZoom: 17,
							max: 1.0,
							gradient: {
								0.4: 'green',
								0.6: 'yellow',
								0.8: 'orange',
								1.0: 'red',
							},
						},
					).addTo(map)
					layers['Severity Heatmap'] = heatmapLayer

					// Add each cluster as a layer group
					clusters.forEach((cluster, idx) => {
						const layerGroup = L.layerGroup()

						// Build popup content once for the cluster
						const typeBreakdownHTML = Object.entries(
							cluster.type_breakdown,
						)
							.map(([type, count]) => `${type}: ${count}`)
							.join('<br>')

						const popupContent = `
                    <div style="min-width: 200px;">
                        <h4 style="margin:0 0 8px 0;">Hotspot #${cluster.rank}</h4>
                        <strong>${cluster.neighborhood}</strong><br>
                        <strong>Issues:</strong> ${cluster.count} (${cluster.n_types} types)<br>
                        <strong>Mean severity:</strong> ${cluster.mean_severity.toFixed(1)}<br>
                        <strong>Spread:</strong> ${cluster.spread_m.toFixed(0)}m<br>
                        <strong>Top type:</strong> ${cluster.top_type}<br>
                        <div style="margin-top:8px;padding-top:8px;border-top:1px solid #ddd;">
                            <strong>Breakdown:</strong><br>
                            ${typeBreakdownHTML}
                        </div>
                    </div>
                `

						// Add all points in the cluster with popup
						cluster.points.forEach((pt) => {
							const marker = L.circleMarker([pt.lat, pt.lng], {
								radius: 2,
								color: cluster.color,
								fillColor: cluster.color,
								fillOpacity: 0.7,
								weight: 1,
							})
							marker.bindPopup(popupContent)
							marker.addTo(layerGroup)
						})

						// Add all clusters to map by default
						layerGroup.addTo(map)

						layers[cluster.name] = layerGroup
					})

					// Add layer control
					L.control
						.layers(null, layers, { collapsed: false })
						.addTo(map)

					console.log(
						`Loaded ${clusters.length} clusters with ${heatmapData.length} severity points`,
					)
				})
				.catch((err) => {
					console.error('Error loading data:', err)

					// Show helpful error message
					const errorDiv = document.createElement('div')
					errorDiv.style.cssText =
						'position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:white;padding:30px;border-radius:10px;box-shadow:0 4px 20px rgba(0,0,0,0.3);max-width:500px;z-index:10000;font-family:sans-serif;'
					errorDiv.innerHTML = `
                <h3 style="margin:0 0 15px 0;color:#d32f2f;">‚ö†Ô∏è Cannot Load Map Data</h3>
                <p style="margin:10px 0;">The browser blocked loading JSON files due to CORS restrictions.</p>
                <p style="margin:10px 0;"><strong>Solution:</strong> Start a local web server:</p>
                <pre style="background:#f5f5f5;padding:10px;border-radius:5px;overflow-x:auto;">cd everyday
./serve.sh</pre>
                <p style="margin:10px 0;font-size:13px;color:#666;">Or run: <code>python3 -m http.server 8000</code></p>
                <p style="margin:10px 0;font-size:13px;color:#666;">Then open: <strong>http://localhost:8000/index.html</strong></p>
            `
					document.body.appendChild(errorDiv)
				})
		</script>
	</body>
</html>
