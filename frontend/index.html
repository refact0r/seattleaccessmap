<!doctype html>
<html>
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Seattle Sidewalk Accessibility Hotspots</title>
		<link
			rel="stylesheet"
			href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
		/>
		<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
		<script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
		<style>
			body {
				margin: 0;
				padding: 0;
				font-family:
					-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto,
					Oxygen, Ubuntu, Cantarell, sans-serif;
			}
			#map {
				width: 100%;
				height: 100vh;
			}
			.info-panel {
				position: absolute;
				top: 10px;
				left: 10px;
				background: white;
				padding: 15px 20px;
				border-radius: 8px;
				box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
				z-index: 1000;
				max-width: 300px;
			}
			.info-panel h3 {
				margin: 0 0 10px 0;
				font-size: 16px;
			}
			.info-panel p {
				margin: 5px 0;
				font-size: 13px;
				color: #666;
			}
			.loading {
				text-align: center;
				padding: 20px;
			}
			.legend {
				position: absolute;
				bottom: 30px;
				right: 10px;
				background: white;
				padding: 10px 15px;
				border-radius: 8px;
				box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
				z-index: 1000;
			}
			.legend h4 {
				margin: 0 0 8px 0;
				font-size: 13px;
			}
			.legend-item {
				display: flex;
				align-items: center;
				margin: 4px 0;
				font-size: 12px;
			}
			.legend-color {
				width: 20px;
				height: 20px;
				border-radius: 50%;
				margin-right: 8px;
				border: 1px solid #333;
			}
			.routing-panel {
				position: absolute;
				top: 50%;
				left: 10px;
				transform: translateY(-50%);
				background: white;
				padding: 15px 20px;
				border-radius: 8px;
				box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
				z-index: 1000;
				max-width: 350px;
			}
			.routing-panel h3 {
				margin: 0 0 10px 0;
				font-size: 16px;
			}
			.routing-panel.hidden {
				display: none;
			}
			.route-stats {
				margin: 10px 0;
				padding: 10px;
				background: #f5f5f5;
				border-radius: 5px;
				font-size: 13px;
			}
			.route-stats h4 {
				margin: 0 0 5px 0;
				font-size: 13px;
				display: flex;
				align-items: center;
			}
			.route-stats .color-box {
				width: 16px;
				height: 16px;
				margin-right: 8px;
				border: 2px solid #333;
			}
			.route-stats p {
				margin: 3px 0;
				font-size: 12px;
				color: #555;
			}
			.comparison {
				margin-top: 10px;
				padding-top: 10px;
				border-top: 1px solid #ddd;
				font-size: 12px;
			}
			.comparison p {
				margin: 3px 0;
			}
			.route-input-panel {
				position: absolute;
				top: 10px;
				right: 10px;
				background: white;
				padding: 15px 20px;
				border-radius: 8px;
				box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
				z-index: 1000;
				max-width: 300px;
			}
			.route-input-panel h3 {
				margin: 0 0 10px 0;
				font-size: 16px;
			}
			.input-group {
				margin: 10px 0;
			}
			.input-group label {
				display: block;
				font-size: 12px;
				font-weight: bold;
				margin-bottom: 4px;
				color: #333;
			}
			.input-row {
				display: flex;
				gap: 8px;
			}
			.input-row input {
				flex: 1;
				padding: 6px 8px;
				border: 1px solid #ddd;
				border-radius: 4px;
				font-size: 12px;
			}
			.input-row input:focus {
				outline: none;
				border-color: #3498db;
			}
			.btn {
				width: 100%;
				padding: 10px;
				background: #3498db;
				color: white;
				border: none;
				border-radius: 5px;
				cursor: pointer;
				font-size: 14px;
				font-weight: bold;
				margin-top: 10px;
			}
			.btn:hover {
				background: #2980b9;
			}
			.btn:disabled {
				background: #95a5a6;
				cursor: not-allowed;
			}
			.status-message {
				margin-top: 10px;
				padding: 8px;
				border-radius: 4px;
				font-size: 12px;
				text-align: center;
			}
			.status-message.loading {
				background: #fff3cd;
				color: #856404;
			}
			.status-message.success {
				background: #d4edda;
				color: #155724;
			}
			.status-message.error {
				background: #f8d7da;
				color: #721c24;
			}
			.examples {
				margin-top: 10px;
				padding: 8px;
				background: #f8f9fa;
				border-radius: 4px;
				font-size: 11px;
			}
			.examples p {
				margin: 4px 0;
				color: #666;
			}
			.examples a {
				color: #3498db;
				cursor: pointer;
				text-decoration: underline;
			}
			.click-mode-buttons {
				display: flex;
				gap: 8px;
				margin-bottom: 10px;
			}
			.click-mode-btn {
				flex: 1;
				padding: 8px;
				background: #ecf0f1;
				color: #333;
				border: 2px solid #bdc3c7;
				border-radius: 4px;
				cursor: pointer;
				font-size: 12px;
				font-weight: bold;
				transition: all 0.2s;
			}
			.click-mode-btn:hover {
				background: #d5dbdb;
			}
			.click-mode-btn.active {
				background: #3498db;
				color: white;
				border-color: #2980b9;
			}
			.click-mode-btn.origin.active {
				background: #e74c3c;
				border-color: #c0392b;
			}
			.click-mode-btn.destination.active {
				background: #27ae60;
				border-color: #229954;
			}
			.map-click-cursor {
				cursor: crosshair !important;
			}
		</style>
	</head>
	<body>
		<div id="map"></div>
		<div class="info-panel">
			<h3>üö∂ Seattle Sidewalk Accessibility</h3>
			<p>Top 30 hotspots identified by cluster analysis</p>
			<p>
				<strong>Toggle layers</strong> using the control in the
				top-right
			</p>
			<p><strong>Click any point</strong> for detailed breakdown</p>
		</div>

		<div id="routing-panel" class="routing-panel hidden">
			<h3>üó∫Ô∏è Route Comparison</h3>
			<div id="route-content">
				<p style="color: #666; font-size: 13px;">Loading routes...</p>
			</div>
		</div>

		<div class="route-input-panel">
			<h3>üìç Calculate Route</h3>
			<div class="click-mode-buttons">
				<button id="set-origin-btn" class="click-mode-btn origin">üìç Click for Origin</button>
				<button id="set-destination-btn" class="click-mode-btn destination">üéØ Click for Destination</button>
			</div>
			<div class="input-group">
				<label>Origin</label>
				<div class="input-row">
					<input type="number" id="start-lat" placeholder="Lat" step="0.0001" value="47.6062">
					<input type="number" id="start-lng" placeholder="Lng" step="0.0001" value="-122.3321">
				</div>
			</div>
			<div class="input-group">
				<label>Destination</label>
				<div class="input-row">
					<input type="number" id="end-lat" placeholder="Lat" step="0.0001" value="47.6205">
					<input type="number" id="end-lng" placeholder="Lng" step="0.0001" value="-122.3493">
				</div>
			</div>
			<button id="calculate-btn" class="btn">Calculate Routes</button>
			<div id="status-message"></div>
			<div class="examples">
				<p><strong>Examples:</strong></p>
				<p><a onclick="setExample1()">Pioneer Sq ‚Üí Pike Place</a></p>
				<p><a onclick="setExample2()">UW ‚Üí Capitol Hill</a></p>
			</div>
		</div>

		<script>
			// Initialize map with zoom controls in bottom-left
			const map = L.map('map', {
				zoomControl: false,
			})

			// Add zoom control to bottom-left
			L.control
				.zoom({
					position: 'bottomleft',
				})
				.addTo(map)

			// Click-to-set mode state
			let clickMode = null // 'origin' or 'destination'
			let originMarker = null
			let destinationMarker = null

			// Add base tile layer
			L.tileLayer(
				'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',
				{
					attribution:
						'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
					subdomains: 'abcd',
					maxZoom: 20,
				},
			).addTo(map)

			// Layer groups
			const layers = {}
			let heatmapLayer = null
			let accessibleRouteLayer = null
			let standardRouteLayer = null

			// Load cluster data from API and render visualizations
			fetch('http://localhost:5001/api/clusters')
				.then((r) => r.json())
				.then((data) => {
					const { config, clusters, heatmap_data } = data

					// Set map view from config
					map.setView(config.center, config.zoom_start)

					// Add heatmap layer (severe barriers only)
					heatmapLayer = L.heatLayer(
						heatmap_data.map(([lat, lng, severity]) => [
							lat,
							lng,
							severity / 5,
						]),
						{
							radius: 6,
							blur: 10,
							maxZoom: 17,
							max: 1.0,
							gradient: {
								0.4: 'green',
								0.6: 'yellow',
								0.8: 'orange',
								1.0: 'red',
							},
						},
					).addTo(map)
					layers['Severity Heatmap'] = heatmapLayer

					// Add each cluster as a layer group
					clusters.forEach((cluster) => {
						const layerGroup = L.layerGroup()

						// Build popup content for the cluster
						const typeBreakdownHTML = Object.entries(cluster.type_breakdown)
							.map(([type, count]) => `${type}: ${count}`)
							.join('<br>')

						const popupContent = `
							<div style="min-width: 200px;">
								<h4 style="margin:0 0 8px 0;">Hotspot #${cluster.rank}</h4>
								<strong>${cluster.neighborhood}</strong><br>
								<strong>Issues:</strong> ${cluster.count} (${cluster.n_types} types)<br>
								<strong>Mean severity:</strong> ${cluster.mean_severity.toFixed(1)}<br>
								<strong>Spread:</strong> ${cluster.spread_m.toFixed(0)}m<br>
								<strong>Top type:</strong> ${cluster.top_type}<br>
								<div style="margin-top:8px;padding-top:8px;border-top:1px solid #ddd;">
									<strong>Breakdown:</strong><br>
									${typeBreakdownHTML}
								</div>
							</div>
						`

						// Add all points in the cluster with popup
						cluster.points.forEach((pt) => {
							const marker = L.circleMarker([pt.lat, pt.lng], {
								radius: 2,
								color: cluster.color,
								fillColor: cluster.color,
								fillOpacity: 0.7,
								weight: 1,
							})
							marker.bindPopup(popupContent)
							marker.addTo(layerGroup)
						})

						// Add all clusters to map by default
						layerGroup.addTo(map)

						layers[cluster.name] = layerGroup
					})

					// Add layer control
					L.control
						.layers(null, layers, { collapsed: false })
						.addTo(map)

					console.log(`Loaded ${clusters.length} clusters with ${heatmap_data.length} severity points`)
				})
				.catch((err) => {
					console.error('Error loading clusters:', err)

					// Show helpful error message
					const errorDiv = document.createElement('div')
					errorDiv.style.cssText =
						'position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:white;padding:30px;border-radius:10px;box-shadow:0 4px 20px rgba(0,0,0,0.3);max-width:500px;z-index:10000;font-family:sans-serif;'
					errorDiv.innerHTML = `
						<h3 style="margin:0 0 15px 0;color:#d32f2f;">‚ö†Ô∏è Cannot Load Cluster Data</h3>
						<p style="margin:10px 0;">Failed to connect to the routing API.</p>
						<p style="margin:10px 0;"><strong>Solution:</strong> Start the backend server:</p>
						<pre style="background:#f5f5f5;padding:10px;border-radius:5px;overflow-x:auto;">python3 backend/app.py</pre>
						<p style="margin:10px 0;font-size:13px;color:#666;">The server should be running on <strong>http://localhost:5001</strong></p>
					`
					document.body.appendChild(errorDiv)
				})

			// Click-to-set mode handlers
			document.getElementById('set-origin-btn').addEventListener('click', () => {
				if (clickMode === 'origin') {
					clickMode = null
					document.getElementById('set-origin-btn').classList.remove('active')
					document.getElementById('map').classList.remove('map-click-cursor')
				} else {
					clickMode = 'origin'
					document.getElementById('set-origin-btn').classList.add('active')
					document.getElementById('set-destination-btn').classList.remove('active')
					document.getElementById('map').classList.add('map-click-cursor')
				}
			})

			document.getElementById('set-destination-btn').addEventListener('click', () => {
				if (clickMode === 'destination') {
					clickMode = null
					document.getElementById('set-destination-btn').classList.remove('active')
					document.getElementById('map').classList.remove('map-click-cursor')
				} else {
					clickMode = 'destination'
					document.getElementById('set-destination-btn').classList.add('active')
					document.getElementById('set-origin-btn').classList.remove('active')
					document.getElementById('map').classList.add('map-click-cursor')
				}
			})

			// Map click handler
			map.on('click', (e) => {
				if (!clickMode) return

				const lat = e.latlng.lat.toFixed(4)
				const lng = e.latlng.lng.toFixed(4)

				if (clickMode === 'origin') {
					document.getElementById('start-lat').value = lat
					document.getElementById('start-lng').value = lng

					// Update or create origin marker
					if (originMarker) {
						map.removeLayer(originMarker)
					}
					originMarker = L.marker([e.latlng.lat, e.latlng.lng], {
						icon: L.divIcon({
							className: 'custom-marker',
							html: '<div style="background: #e74c3c; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);"></div>',
							iconSize: [20, 20],
							iconAnchor: [10, 10]
						})
					}).addTo(map)

					// Deactivate click mode
					clickMode = null
					document.getElementById('set-origin-btn').classList.remove('active')
					document.getElementById('map').classList.remove('map-click-cursor')
				} else if (clickMode === 'destination') {
					document.getElementById('end-lat').value = lat
					document.getElementById('end-lng').value = lng

					// Update or create destination marker
					if (destinationMarker) {
						map.removeLayer(destinationMarker)
					}
					destinationMarker = L.marker([e.latlng.lat, e.latlng.lng], {
						icon: L.divIcon({
							className: 'custom-marker',
							html: '<div style="background: #27ae60; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);"></div>',
							iconSize: [20, 20],
							iconAnchor: [10, 10]
						})
					}).addTo(map)

					// Deactivate click mode
					clickMode = null
					document.getElementById('set-destination-btn').classList.remove('active')
					document.getElementById('map').classList.remove('map-click-cursor')
				}
			})

			// Example location presets
			function setExample1() {
				document.getElementById('start-lat').value = 47.6062
				document.getElementById('start-lng').value = -122.3321
				document.getElementById('end-lat').value = 47.6205
				document.getElementById('end-lng').value = -122.3493
				updateMarkers()
			}

			function setExample2() {
				document.getElementById('start-lat').value = 47.6553
				document.getElementById('start-lng').value = -122.3035
				document.getElementById('end-lat').value = 47.6205
				document.getElementById('end-lng').value = -122.3212
				updateMarkers()
			}

			function updateMarkers() {
				const startLat = parseFloat(document.getElementById('start-lat').value)
				const startLng = parseFloat(document.getElementById('start-lng').value)
				const endLat = parseFloat(document.getElementById('end-lat').value)
				const endLng = parseFloat(document.getElementById('end-lng').value)

				if (!isNaN(startLat) && !isNaN(startLng)) {
					if (originMarker) map.removeLayer(originMarker)
					originMarker = L.marker([startLat, startLng], {
						icon: L.divIcon({
							className: 'custom-marker',
							html: '<div style="background: #e74c3c; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);"></div>',
							iconSize: [20, 20],
							iconAnchor: [10, 10]
						})
					}).addTo(map)
				}

				if (!isNaN(endLat) && !isNaN(endLng)) {
					if (destinationMarker) map.removeLayer(destinationMarker)
					destinationMarker = L.marker([endLat, endLng], {
						icon: L.divIcon({
							className: 'custom-marker',
							html: '<div style="background: #27ae60; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);"></div>',
							iconSize: [20, 20],
							iconAnchor: [10, 10]
						})
					}).addTo(map)
				}
			}

			// Calculate route button handler
			document
				.getElementById('calculate-btn')
				.addEventListener('click', async () => {
					const startLat = parseFloat(
						document.getElementById('start-lat').value,
					)
					const startLng = parseFloat(
						document.getElementById('start-lng').value,
					)
					const endLat = parseFloat(
						document.getElementById('end-lat').value,
					)
					const endLng = parseFloat(
						document.getElementById('end-lng').value,
					)

					// Validate inputs
					if (
						isNaN(startLat) ||
						isNaN(startLng) ||
						isNaN(endLat) ||
						isNaN(endLng)
					) {
						showStatus('Please enter valid coordinates', 'error')
						return
					}

					// Show loading state
					const btn = document.getElementById('calculate-btn')
					btn.disabled = true
					btn.textContent = 'Calculating...'
					showStatus('Calculating routes...', 'loading')

					try {
						// Call backend API
						const response = await fetch(
							'http://localhost:5001/api/calculate_route',
							{
								method: 'POST',
								headers: {
									'Content-Type': 'application/json',
								},
								body: JSON.stringify({
									start_lat: startLat,
									start_lng: startLng,
									end_lat: endLat,
									end_lng: endLng,
								}),
							},
						)

						if (!response.ok) {
							throw new Error(
								`Server error: ${response.statusText}`,
							)
						}

						const data = await response.json()

						// Clear existing route layers
						if (accessibleRouteLayer) {
							map.removeLayer(accessibleRouteLayer)
							delete layers['üü¢ Accessible Route']
						}
						if (standardRouteLayer) {
							map.removeLayer(standardRouteLayer)
							delete layers['üîµ Standard Route']
						}

						// Add new routes
						accessibleRouteLayer = L.geoJSON(
							data.accessible_route,
							{
								style: {
									color: '#2ecc71',
									weight: 5,
									opacity: 0.8,
								},
							},
						).addTo(map)

						standardRouteLayer = L.geoJSON(data.standard_route, {
							style: {
								color: '#3498db',
								weight: 5,
								opacity: 0.8,
							},
						}).addTo(map)

						// Update layers
						layers['üü¢ Accessible Route'] = accessibleRouteLayer
						layers['üîµ Standard Route'] = standardRouteLayer

						// Recreate layer control
						document
							.querySelector('.leaflet-control-layers')
							?.remove()
						L.control
							.layers(null, layers, { collapsed: false })
							.addTo(map)

						// Display statistics
						displayRouteStats(data.stats)

						// Zoom to routes
						const allBounds = L.featureGroup([
							accessibleRouteLayer,
							standardRouteLayer,
						]).getBounds()
						map.fitBounds(allBounds, { padding: [50, 50] })

						showStatus('Routes calculated!', 'success')
					} catch (error) {
						console.error('Error calculating route:', error)
						showStatus(
							'Error: Make sure routing server is running (python3 backend/app.py)',
							'error',
						)
					} finally {
						btn.disabled = false
						btn.textContent = 'Calculate Routes'
					}
				})

			function showStatus(message, type) {
				const statusDiv = document.getElementById('status-message')
				statusDiv.textContent = message
				statusDiv.className = `status-message ${type}`
				if (type === 'success') {
					setTimeout(() => {
						statusDiv.textContent = ''
						statusDiv.className = ''
					}, 3000)
				}
			}

			function displayRouteStats(stats) {
				const routingPanel = document.getElementById('routing-panel')
				const routeContent = document.getElementById('route-content')

				const extraDistance =
					stats.accessible_length - stats.standard_length
				const extraPercent = (
					(stats.accessible_length / stats.standard_length - 1) *
					100
				).toFixed(1)
				const barrierReduction = (
					((stats.standard_barrier_cost -
						stats.accessible_barrier_cost) /
						Math.max(stats.standard_barrier_cost, 0.01)) *
					100
				).toFixed(1)

				routeContent.innerHTML = `
                    <div class="route-stats">
                        <h4>
                            <div class="color-box" style="background: #2ecc71;"></div>
                            Accessible Route
                        </h4>
                        <p>Distance: ${stats.accessible_length.toFixed(0)} m</p>
                        <p>Barrier exposure: ${stats.accessible_barrier_cost.toFixed(1)}</p>
                    </div>

                    <div class="route-stats">
                        <h4>
                            <div class="color-box" style="background: #3498db;"></div>
                            Standard Route
                        </h4>
                        <p>Distance: ${stats.standard_length.toFixed(0)} m</p>
                        <p>Barrier exposure: ${stats.standard_barrier_cost.toFixed(1)}</p>
                    </div>

                    <div class="comparison">
                        <strong>Trade-off:</strong>
                        <p>Extra distance: ${extraDistance.toFixed(0)} m (${extraPercent > 0 ? '+' : ''}${extraPercent}%)</p>
                        <p style="color: #27ae60;">‚úì Barrier reduction: ${barrierReduction}%</p>
                    </div>
                `

				routingPanel.classList.remove('hidden')
			}
		</script>
	</body>
</html>
